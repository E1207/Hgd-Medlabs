<div class="list-container">
  <!-- Modern Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="title-section">
        <div class="icon-wrapper">
          <mat-icon>folder_open</mat-icon>
        </div>
        <div>
          <h1>Historique des Résultats</h1>
          <p class="subtitle">Gérez et suivez tous les résultats de laboratoire</p>
        </div>
      </div>
      <div class="header-actions">
        <div class="search-wrapper">
          <mat-icon>search</mat-icon>
          <input type="text" [(ngModel)]="searchQuery" (keyup.enter)="onSearch()" placeholder="Rechercher...">
        </div>
        <button mat-flat-button color="primary" routerLink="/medlabs/results/upload" class="add-btn">
          <mat-icon>add</mat-icon> Nouveau
        </button>
      </div>
    </div>
  </div>

  <!-- Filter Pills -->
  <div class="filter-pills">
    <button [class.active]="!statusFilter" (click)="filterByStatus(undefined)">
      Tous <span class="count">{{ totalElements }}</span>
    </button>
    <button [class.active]="statusFilter === 'IMPORTED'" (click)="filterByStatus('IMPORTED')">
      <span class="dot imported"></span> Importés
    </button>
    <button [class.active]="statusFilter === 'COMPLETED'" (click)="filterByStatus('COMPLETED')">
      <span class="dot completed"></span> Complétés
    </button>
    <button [class.active]="statusFilter === 'SENT'" (click)="filterByStatus('SENT')">
      <span class="dot sent"></span> Envoyés
    </button>
    <button [class.active]="statusFilter === 'OPENED'" (click)="filterByStatus('OPENED')">
      <span class="dot opened"></span> Consultés
    </button>
  </div>

  <!-- Results Table -->
  <div class="table-card">
    <table mat-table [dataSource]="results" class="results-table" *ngIf="results.length > 0">
      <ng-container matColumnDef="referenceDossier">
        <th mat-header-cell *matHeaderCellDef>Référence</th>
        <td mat-cell *matCellDef="let result">
          <span class="reference-badge">{{ result.referenceDossier }}</span>
          <div class="import-method" *ngIf="result.importMethod">
            <mat-icon class="mini-icon">{{ result.importMethod === 'AUTO' ? 'autorenew' : 'person' }}</mat-icon>
            {{ result.importMethod === 'AUTO' ? 'Auto' : 'Manuel' }}
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="patient">
        <th mat-header-cell *matHeaderCellDef>Patient</th>
        <td mat-cell *matCellDef="let result">
          <div class="patient-cell" *ngIf="result.patientLastName || result.patientFirstName">
            <div class="patient-avatar">{{ getPatientInitials(result) }}</div>
            <span>{{ result.patientLastName || '' }} {{ result.patientFirstName || '' }}</span>
          </div>
          <span *ngIf="!result.patientFirstName && !result.patientLastName" class="incomplete-tag">
            <mat-icon>edit</mat-icon> À compléter
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="email">
        <th mat-header-cell *matHeaderCellDef>Email</th>
        <td mat-cell *matCellDef="let result" class="email-cell">
          {{ result.patientEmail || '—' }}
        </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Statut</th>
        <td mat-cell *matCellDef="let result">
          <span class="status-chip" [ngClass]="result.status">
            <span class="status-dot"></span>
            {{ getStatusLabel(result.status) }}
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef>Date</th>
        <td mat-cell *matCellDef="let result" class="date-cell">
          {{ result.createdAt | date:'dd/MM/yyyy HH:mm' }}
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let result">
          <div class="action-buttons">
            <button mat-icon-button matTooltip="Compléter" class="action-btn edit"
                    *ngIf="result.status === 'IMPORTED'" (click)="openCompleteDialog(result)">
              <mat-icon>edit_note</mat-icon>
            </button>
            <button mat-icon-button matTooltip="Envoyer" class="action-btn send"
                    *ngIf="result.status === 'COMPLETED'" (click)="sendResult(result)">
              <mat-icon>send</mat-icon>
            </button>
            <button mat-icon-button matTooltip="Visualiser" class="action-btn view" (click)="viewPdf(result)">
              <mat-icon>visibility</mat-icon>
            </button>
            <button mat-icon-button matTooltip="Télécharger" class="action-btn download" (click)="downloadPdf(result)">
              <mat-icon>download</mat-icon>
            </button>
            <button mat-icon-button matTooltip="Supprimer" class="action-btn delete" (click)="deleteResult(result)">
              <mat-icon>delete_outline</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns" [class.imported-row]="row.status === 'IMPORTED'"></tr>
    </table>

    <div class="empty-state" *ngIf="results.length === 0 && !loading">
      <mat-icon>inbox</mat-icon>
      <h3>Aucun résultat trouvé</h3>
      <p>Commencez par importer un nouveau résultat</p>
      <button mat-flat-button color="primary" routerLink="/medlabs/results/upload">
        <mat-icon>add</mat-icon> Ajouter un résultat
      </button>
    </div>

    <div class="loading-state" *ngIf="loading">
      <mat-icon>hourglass_empty</mat-icon>
      <p>Chargement en cours...</p>
    </div>

    <mat-paginator *ngIf="totalElements > 0"
      [length]="totalElements" [pageSize]="pageSize"
      [pageSizeOptions]="[5, 10, 25, 50]"
      (page)="onPageChange($event)" showFirstLastButtons>
    </mat-paginator>
  </div>
</div>
