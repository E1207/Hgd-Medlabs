<div class="storage-container">
  <div class="page-header">
    <h1>
      <mat-icon>storage</mat-icon>
      Gestion du Stockage Local
    </h1>
    <p class="subtitle">Surveillance et maintenance du stockage des fichiers PDF</p>
  </div>

  <!-- Statistiques principales -->
  <div class="stats-grid" *ngIf="stats; else loadingStats">
    <!-- Espace disque -->
    <mat-card class="stat-card disk-usage">
      <mat-card-header>
        <mat-icon mat-card-avatar [class]="stats.alertLevel.toLowerCase()">
          {{ stats.alertLevel === 'OK' ? 'check_circle' : stats.alertLevel === 'WARNING' ? 'warning' : 'error' }}
        </mat-icon>
        <mat-card-title>Espace Disque</mat-card-title>
        <mat-card-subtitle>{{ stats.alertMessage }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="usage-info">
          <span class="usage-text">{{ stats.usagePercentage | number:'1.1-1' }}% utilisé</span>
          <span class="free-text">{{ stats.freeSpaceGB }} Go libres sur {{ stats.totalSpaceGB }} Go</span>
        </div>
        <mat-progress-bar 
          [mode]="'determinate'" 
          [value]="stats.usagePercentage"
          [class]="stats.alertLevel.toLowerCase()">
        </mat-progress-bar>
      </mat-card-content>
    </mat-card>

    <!-- Fichiers -->
    <mat-card class="stat-card files-count">
      <mat-card-header>
        <mat-icon mat-card-avatar class="primary">picture_as_pdf</mat-icon>
        <mat-card-title>Fichiers PDF</mat-card-title>
        <mat-card-subtitle>Total des résultats stockés</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="big-number">{{ stats.totalFiles | number }}</div>
        <div class="stat-detail">fichiers dans le système</div>
      </mat-card-content>
    </mat-card>

    <!-- Espace utilisé -->
    <mat-card class="stat-card space-used">
      <mat-card-header>
        <mat-icon mat-card-avatar class="accent">folder</mat-icon>
        <mat-card-title>Espace Utilisé</mat-card-title>
        <mat-card-subtitle>Par les fichiers MedLab</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="big-number">{{ stats.totalUsedMB | number }} Mo</div>
        <div class="stat-detail">total utilisé</div>
      </mat-card-content>
    </mat-card>
  </div>

  <ng-template #loadingStats>
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <span>Chargement des statistiques...</span>
    </div>
  </ng-template>

  <!-- Détails des répertoires -->
  <mat-card class="directories-card" *ngIf="stats">
    <mat-card-header>
      <mat-icon mat-card-avatar>folder_open</mat-icon>
      <mat-card-title>Répertoires de Stockage</mat-card-title>
      <mat-card-subtitle>Chemins configurés sur le serveur</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="directory-list">
        <div class="directory-item">
          <mat-icon>cloud_upload</mat-icon>
          <div class="directory-info">
            <span class="directory-label">Uploads (résultats manuels)</span>
            <code class="directory-path">{{ stats.uploadsDirPath }}</code>
          </div>
          <span class="directory-size">{{ stats.uploadsDirSizeMB }} Mo</span>
        </div>
        <mat-divider></mat-divider>
        <div class="directory-item">
          <mat-icon>visibility</mat-icon>
          <div class="directory-info">
            <span class="directory-label">Incoming (import automatique)</span>
            <code class="directory-path">{{ stats.watchDirPath }}</code>
          </div>
          <span class="directory-size">{{ stats.watchDirSizeMB }} Mo</span>
        </div>
        <mat-divider *ngIf="stats.archiveDirPath"></mat-divider>
        <div class="directory-item" *ngIf="stats.archiveDirPath">
          <mat-icon>archive</mat-icon>
          <div class="directory-info">
            <span class="directory-label">Archives (fichiers anciens)</span>
            <code class="directory-path">{{ stats.archiveDirPath }}</code>
          </div>
          <span class="directory-size">{{ stats.archiveDirSizeMB }} Mo</span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Actions de maintenance -->
  <mat-card class="actions-card">
    <mat-card-header>
      <mat-icon mat-card-avatar>build</mat-icon>
      <mat-card-title>Actions de Maintenance</mat-card-title>
      <mat-card-subtitle>Opérations administratives</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="actions-grid">
        <!-- Rafraîchir -->
        <button mat-raised-button color="primary" (click)="loadStats()" [disabled]="loading">
          <mat-icon>refresh</mat-icon>
          Actualiser les statistiques
        </button>

        <!-- Vérifier l'intégrité -->
        <button mat-raised-button (click)="checkIntegrity()" [disabled]="checkingIntegrity">
          <mat-icon>verified_user</mat-icon>
          {{ checkingIntegrity ? 'Vérification...' : 'Vérifier l\'intégrité' }}
        </button>

        <!-- Créer une sauvegarde -->
        <button mat-raised-button color="accent" (click)="createBackup()" [disabled]="creatingBackup">
          <mat-icon>backup</mat-icon>
          {{ creatingBackup ? 'Sauvegarde en cours...' : 'Créer une sauvegarde' }}
        </button>

        <!-- Archiver -->
        <button mat-raised-button (click)="triggerArchive()" [disabled]="archiving">
          <mat-icon>archive</mat-icon>
          {{ archiving ? 'Archivage...' : 'Archiver les anciens fichiers' }}
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Résultat de la vérification d'intégrité -->
  <mat-card class="integrity-card" *ngIf="integrityResult">
    <mat-card-header>
      <mat-icon mat-card-avatar [class]="integrityResult.success ? 'ok' : 'critical'">
        {{ integrityResult.success ? 'check_circle' : 'error' }}
      </mat-icon>
      <mat-card-title>Résultat de la Vérification</mat-card-title>
      <mat-card-subtitle>
        {{ integrityResult.totalFiles }} fichiers vérifiés
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div *ngIf="integrityResult.success" class="success-message">
        <mat-icon>check</mat-icon>
        Tous les fichiers sont intègres. Aucun problème détecté.
      </div>
      <div *ngIf="!integrityResult.success" class="error-details">
        <div *ngIf="integrityResult.corruptedFiles.length > 0">
          <strong>Fichiers corrompus ({{ integrityResult.corruptedFiles.length }}):</strong>
          <ul>
            <li *ngFor="let file of integrityResult.corruptedFiles">{{ file }}</li>
          </ul>
        </div>
        <div *ngIf="integrityResult.emptyFiles.length > 0">
          <strong>Fichiers vides ({{ integrityResult.emptyFiles.length }}):</strong>
          <ul>
            <li *ngFor="let file of integrityResult.emptyFiles">{{ file }}</li>
          </ul>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
