<div class="verification-container">
  <mat-card class="verification-card">
    <mat-card-header>
      <div class="logo">
        <mat-icon class="hospital-icon">local_hospital</mat-icon>
      </div>
      <mat-card-title>Consultation S√©curis√©e</mat-card-title>
      <mat-card-subtitle>H√¥pital G√©n√©ral de Douala - MedLab</mat-card-subtitle>
    </mat-card-header>

    <!-- √âTAPE 1: Demande OTP WhatsApp -->
    <mat-card-content *ngIf="step === 'request-otp'">
      <div class="step-header">
        <mat-icon class="whatsapp-icon">smartphone</mat-icon>
        <h3>V√©rification par WhatsApp</h3>
      </div>
      
      <p class="info-text">
        Pour acc√©der √† vos r√©sultats m√©dicaux, un code de v√©rification sera envoy√© 
        √† votre num√©ro WhatsApp.
      </p>
      
      <div class="patient-info" *ngIf="resultInfo">
        <p><strong>R√©f√©rence:</strong> {{ resultInfo.referenceDossier }}</p>
        <p><strong>Patient:</strong> {{ resultInfo.patientFirstName }} {{ resultInfo.patientLastName }}</p>
      </div>

      <button mat-raised-button color="primary" class="full-width whatsapp-btn"
              (click)="requestOtp()" [disabled]="loading">
        <mat-icon *ngIf="!loading">send</mat-icon>
        <mat-spinner *ngIf="loading" diameter="20"></mat-spinner>
        <span *ngIf="!loading">Recevoir le code par WhatsApp</span>
        <span *ngIf="loading">Envoi en cours...</span>
      </button>
    </mat-card-content>

    <!-- √âTAPE 2: Saisie du code OTP -->
    <mat-card-content *ngIf="step === 'verify-otp'">
      <div class="step-header">
        <mat-icon class="otp-icon">lock</mat-icon>
        <h3>Saisir le code</h3>
      </div>
      
      <p class="info-text">
        Un code √† 6 chiffres a √©t√© envoy√© au num√©ro 
        <strong>{{ maskedPhone }}</strong>
      </p>
      
      <form [formGroup]="otpForm" (ngSubmit)="verifyOtp()">
        <mat-form-field appearance="outline" class="full-width otp-field">
          <mat-label>Code de v√©rification</mat-label>
          <input matInput formControlName="otpCode" maxlength="6" 
                 placeholder="000000" autocomplete="one-time-code"
                 inputmode="numeric" pattern="[0-9]*">
          <mat-icon matPrefix>dialpad</mat-icon>
          <mat-hint>Code valide pendant {{ otpExpiresIn }} minutes</mat-hint>
        </mat-form-field>

        <button mat-raised-button color="primary" type="submit" class="full-width"
                [disabled]="loading || !otpForm.valid">
          <mat-spinner *ngIf="loading" diameter="20"></mat-spinner>
          <span *ngIf="!loading">V√©rifier le code</span>
          <span *ngIf="loading">V√©rification...</span>
        </button>
      </form>

      <div class="resend-section">
        <p>Code non re√ßu ?</p>
        <button mat-button color="accent" (click)="resendOtp()" 
                [disabled]="resendDisabled || loading">
          <mat-icon>refresh</mat-icon>
          Renvoyer le code {{ resendDisabled ? '(' + resendCountdown + 's)' : '' }}
        </button>
      </div>
    </mat-card-content>

    <!-- √âTAPE 3: Acc√®s au PDF -->
    <mat-card-content *ngIf="step === 'success'">
      <div class="success-message">
        <mat-icon class="success-icon">check_circle</mat-icon>
        <h2>V√©rification r√©ussie !</h2>
      </div>

      <div class="result-info">
        <p><strong>R√©f√©rence:</strong> {{ resultInfo?.referenceDossier }}</p>
        <p><strong>Patient:</strong> {{ resultInfo?.patientFirstName }} {{ resultInfo?.patientLastName }}</p>
        <p *ngIf="resultInfo?.patientBirthdate">
          <strong>Date de naissance:</strong> {{ resultInfo?.patientBirthdate | date:'dd/MM/yyyy' }}
        </p>
      </div>

      <div class="pdf-actions">
        <button mat-raised-button color="primary" class="full-width" (click)="viewPdf()">
          <mat-icon>visibility</mat-icon>
          Voir le r√©sultat
        </button>
        
        <button mat-stroked-button color="primary" class="full-width" (click)="downloadPdf()">
          <mat-icon>download</mat-icon>
          T√©l√©charger le PDF
        </button>
      </div>
    </mat-card-content>

    <!-- ERREUR: Pas de num√©ro de t√©l√©phone -->
    <mat-card-content *ngIf="step === 'no-phone'">
      <div class="error-message">
        <mat-icon class="error-icon">error</mat-icon>
        <h3>V√©rification impossible</h3>
        <p>Aucun num√©ro de t√©l√©phone n'est associ√© √† ce r√©sultat.</p>
        <p>Veuillez contacter le laboratoire de l'H√¥pital G√©n√©ral de Douala.</p>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Footer -->
  <div class="footer">
    <p>üîí Vos donn√©es sont prot√©g√©es par chiffrement AES-256</p>
    <p>¬© 2024 MedLab - H√¥pital G√©n√©ral de Douala</p>
  </div>
</div>

<!-- Modal PDF Viewer -->
<div class="pdf-modal" *ngIf="showPdfViewer" (click)="closePdfViewer()">
  <div class="pdf-modal-content" (click)="$event.stopPropagation()">
    <button mat-icon-button class="close-btn" (click)="closePdfViewer()">
      <mat-icon>close</mat-icon>
    </button>
    <iframe [src]="pdfUrl" class="pdf-viewer"></iframe>
  </div>
</div>
